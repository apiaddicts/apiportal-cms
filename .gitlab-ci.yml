image: docker:latest
services:
  - docker:dind

stages:
  - build
  - deploy

variables:
  DOCKER_IMAGE_PATH: "$CI_REGISTRY_IMAGE"

.template:build: &docker-build
  before_script:
    # Log in to GitLab Container Registry
    - docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com
  script:
    - echo version:$CI_TAG
    - docker build
      --build-arg BUILDKIT_INLINE_CACHE=1
      --cache-from "${DOCKER_IMAGE_PATH}:$TAG"
      -t "${DOCKER_IMAGE_PATH}:$CI_TAG" -t "${DOCKER_IMAGE_PATH}:$TAG" .
    - docker push $DOCKER_IMAGE_PATH:$TAG
    - docker push $DOCKER_IMAGE_PATH:$CI_TAG

.template:deploy: &ssh-deploy
  script:
    - mkdir -p ~/.ssh
    - echo -e "Host *\n\tStrictHostKeyChecking no\n\n" > ~/.ssh/config
    - echo "$PRIVATE_RSA_KEY" | tr -d '\r' > ssh-auth
    - chmod 600 ssh-auth
    - sed -i "s|_VERSION|$CI_COMMIT_SHA|g; s|_IMAGE|$DOCKER_IMAGE_PATH|g;" docker-compose.yaml
    - scp -i ssh-auth docker-compose.yaml $SSH_LOGIN:$REMOTE_PATH/docker-compose.yaml
    - ssh -i ssh-auth $SSH_LOGIN "cd $REMOTE_PATH && docker login -u gitlab-ci-token -p $CI_BUILD_TOKEN registry.gitlab.com && docker-compose down && docker-compose up -d "

docker:build:
  stage: build
  variables:
    TAG: $CI_COMMIT_REF_NAME
    CI_TAG: $CI_COMMIT_SHA

  rules:
    # - if: $CI_COMMIT_TAG =~ /^v[0-9]+(\.[0-9]+)+(\.[0-9]+)$/
    #   variables:
    #     TAG: latest
    #     CI_TAG: $CI_COMMIT_TAG
    # - if: $CI_COMMIT_REF_NAME == "develop"
    - if: $CI_COMMIT_REF_NAME == "main"
  <<: *docker-build
  environment:
    name: $CI_COMMIT_REF_NAME

docker:deploy:
  stage: deploy
  variables:
    SSH_LOGIN: ubuntu@$PRE_UBUNTU
    SSH_KEY: $PRIVATE_RSA_KEY
    REMOTE_PATH: /var/www/aplicacion/devportal-clo-back
  rules:
    # - if: $CI_COMMIT_REF_NAME == "develop"
    #   variables:
    #     REMOTE_PATH: /var/www/aplicacion/devportal-clo-back/dev
    - if: $CI_COMMIT_REF_NAME == "main"
      # variables:
      #   REMOTE_PATH: /var/www/aplicacion/devportal-clo-back/pre
  <<: *ssh-deploy
  environment:
    name: $CI_COMMIT_REF_NAME
